pool: Default

pr:
 - develop

variables:
  dockerImageName: "sharathchandra007/spring-petclinic"
  dockerImageTag: "83"

stages:
  - stage: continous_deployment
    jobs: 
      - job: 'deployment'
        displayName: 'deploy the cluster'
        steps:
          - task: Docker@2
            displayName: Login to ACR
            inputs:
              command: login
              containerRegistry: "DockerCloud"

          - task: CmdLine@2
            displayName: 'docker pull command'
            inputs:
              script: | # The script block allows you to specify the commands to execute in the task.
                echo "Pulling image $(dockerImageName):$(dockerImagetag)"
                docker pull $(dockerImageName):$(dockerImageTag)

          - task: Bash@3
            displayName: "teraform initialization"
            inputs:
              targetType: "inline"
              script: |
               terraform init 
               terraform apply -var-file="defaults.tfvars" -auto-approve
              workingDirectory: "./infra"   

          - task: Bash@3
            displayName: "Deploy to k8s"
            inputs:
              targetType: "inline"
              script: |
                kubectl apply -f spc-deployment.yaml
            # displayName: "Deploy to Kubernetes"
            # inputs:
            #   targetType: "inline"
            #   script: |
            #     kubectl apply -f spc-deployment.yaml
                kubectl get all
                



            # displayName: "Deploy to Kubernetes"
            # inputs:
            #   targetType: 'inline'
            #   script: |
            #     # Set the kubeconfig path
            #     export KUBECONFIG=$(System.DefaultWorkingDirectory)/kubeconfig-file-name

            #     # Apply the Kubernetes deployment file
            #     kubectl apply -f spc-deployment.yaml

            #     # Get all resources
            #     kubectl get all
                

          # - task: DownloadSecureFile@1  # Download kubeconfig from a secure location
          #   inputs:
          #     secureFile: 'kubeconfig-file-name'

          # - task: Bash@3
          #   displayName: "Set up Kubeconfig"
          #   inputs:
          #     targetType: 'inline'
          #     script: |
          #       mkdir -p ~/.kube
          #       cp $(System.DefaultWorkingDirectory)/kubeconfig-file-name ~/.kube/config  # Copy to the default kubeconfig location

          # - task: Kubernetes@1
          #   displayName: "Deploy to k8s"
          #   inputs:
          #     kubernetesServiceConnection: ""
          #     namespace: "default"
          #     command: "apply"
          #     useConfigurationFile: true
          #     configuration: "spc-deployment.yaml"
              
          #     targetType: "inline"
          #     script: |
          #       kubectl get all




                    
